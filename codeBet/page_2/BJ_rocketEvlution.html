<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../ico/ico1.jpg">
    <title>进化算法</title>
    <link rel="stylesheet" type="text/css" href="div_cot.css">
    <style>
        body {
        padding: 0;
        margin: 0;
        overflow-x: hidden;
        }
        .cet{
            position: absolute;
            left: 10px;
            top: 10px;
        }
    </style>
    <script src="../../p5.min.js"></script>
    <script>
        var lifetime=100;
        var lifeCounter=0;
        var rpopulation=null;
        function Rocket(lifetime){
            //physics
            this.position=createVector(width/2,height/2);
            this.velocity=createVector(0,0);
            this.acceleration=createVector(0,0);
            this.fitness=0;
            this.geneCounter=0;
            this.size=3;
            //dnas
            this.maxForce=0.1;
            this.genes=new Array(lifetime);//相当于lifetime
            this.fitness=0;
            this.lifetime=lifetime;
            this.mutationRate=0.01;//突变率**************
            //物理引擎
            this.applyForce=function(f){
                this.acceleration.add(f);
            }
            this.update=function(){
                this.velocity.add(this.acceleration);
                this.position.add(this.velocity);
                this.acceleration.mult(0);
            }
            this.display=function(){
                push();
                    translate(this.position.x,this.position.y);
                    var angle=atan2(this.velocity.y,this.velocity.x);
                    rotate(angle+PI/2);
                    fill(map(this.velocity.mag(),0,1.6,120,255),120,220);
                    noStroke();
                    beginShape();
                        vertex(0,-this.size*2);
                        vertex(-this.size,this.size*2);
                        vertex(0,this.size*1);
                        vertex(this.size,this.size*2);
                    endShape();
                pop();
            }
            //进化引擎
            this.initDNA=function(){
                for(var i=0;i<this.genes.length;i++){
                    this.genes[i]=p5.Vector.random2D();
                    this.genes[i].mult(random(0,this.maxForce));                
                }
            }
            this.setGenes=function(i,geneset){
                //设定基因型
                this.genes[i]=geneset;
            }
            this.calculateFitness=function(target){
                //target是一个向量
                //计算适合度
                var d=dist(this.position.x,this.position.y,target.x,target.y);
                var currentFitness=pow(1/d,2);
                this.fitness=currentFitness;
                return(currentFitness);
            }
            this.crossover=function(partner){
                //交配【拼接基因型】
                var child=new Rocket(this.lifetime);
                var midpoint=int(random(this.genes.length));
                for(var i=0;i<this.genes.length;i++){
                    if(i>midpoint){
                        child.setGenes(i,this.genes[i]);
                    }else{
                        child.setGenes(i,partner.genes[i]);
                    }
                }
                return(child);
            }
            this.mutate=function(){
                //突变
                for(var i=0;i<this.genes.length;i++){
                    if(random(1)<this.mutationRate){
                        this.genes[i]=p5.Vector.random2D();
                    }
                }
            }
            this.run=function(){
                this.applyForce(this.genes[this.geneCounter]);
                this.geneCounter+=1;
                this.update();
                this.display();
            }
        }
        function PopulationControler(lifetime,size){
            //管理对象
            this.population=[];
            this.matingPool=[];
            this.generations=0;
            this.size=size;
            this.init=function(){
                for(var i=0;i<this.size;i++){
                    this.population.push(new Rocket(lifetime));
                }
                for(var i=0;i<this.population.length;i++){
                    this.population[i].initDNA();
                }
            }
            this.fitnessCalculate=function(target){
                for(var i=0;i<this.population.length;i++){
                    this.population[i].calculateFitness(target);
                }
            }
            this.mating=function(){
                //交配池
                this.matingPool=[];
                for(var i=0;i<this.population.length;i++){
                    var n=int(this.population[i].fitness*100);
                    for(var j=0;j<n;j++){
                        this.matingPool.push(this.population[i]);
                    }
                }
            }
            this.born=function(){
                //繁殖
                for(var i=0;i<this.population.length;i++){
                    var a=int(random(0,this.matingPool.length));
                    var b=int(random(0,this.matingPool.length));
                    var parentA=this.matingPool[a];
                    var parentB=this.matingPool[b];
                    console.log(a,b,parentA,parentB);
                    var child=parentA.crossover(parentB);
                    //突变
                    child.mutate();
                    this.population[i]=child;
                }
            }
            this.show=function(){
                //显示物理性运动
                for(var i=0;i<this.population.length;i++){
                    this.population[i].run();
                }
            }
        }
        function setup() {
            createCanvas(windowWidth, windowHeight);
            smooth();
            rpopulation=new PopulationControler(lifetime,30);
            rpopulation.init();
        }
        function windowResized() {
            resizeCanvas(windowWidth,windowHeight);
        }
        function draw(){
            background(0);
            if(lifeCounter<lifetime){
                rpopulation.show();
                lifeCounter+=1;
            }else{
                lifeCounter=0;
                rpopulation.fitnessCalculate(createVector(width,height));
                rpopulation.mating();
                rpopulation.born();
            }
        }
    </script>
    </head>

    <body>
    <main>
    </main>
    <div class="cot">
        <h1>分形树</h1>
        <hr>
        <hr>
        <a class="back" href="../../mainPage/mainPage_2.html">退出</a>
        <hr>
    </div>
    </body>
</html>